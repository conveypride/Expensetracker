<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanceTrack</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4F46E5">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2910/2910296.png">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #4F46E5; /* Indigo */
            --bg-body: #F3F4F6;
            --bg-card: #ffffff;
            --text-main: #1F2937;
            --text-muted: #6B7280;
            --danger: #EF4444; 
            --success: #10B981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body { background-color: var(--bg-body); color: var(--text-main); display: flex; min-height: 100vh; }

        /* LOCK SCREEN */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #111827; z-index: 9999; display: flex; 
            justify-content: center; align-items: center; color: white;
        }
        .login-box {
            background: #1F2937; padding: 40px; border-radius: 12px; 
            text-align: center; width: 350px; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .login-box h2 { margin-bottom: 10px; color: var(--primary); }
        .login-input {
            width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px;
            border: 1px solid #374151; background: #374151; color: white; outline: none; text-align: center;
        }
        .login-btn {
            width: 100%; padding: 12px; background: var(--primary); color: white;
            border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
        }
        .error-msg { color: var(--danger); font-size: 0.85rem; margin-top: 10px; display: none; }

        /* APP CONTAINER (Hidden initially) */
        #app-container { display: none; width: 100%; display: flex; }

        /* Sidebar */
        .sidebar {
            width: 260px; background: #111827; color: white; padding: 20px;
            display: flex; flex-direction: column; position: fixed; height: 100%; z-index: 10;
        }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 40px; color: var(--primary); font-weight: 700; letter-spacing: 1px;}
        .nav-item {
            padding: 12px 15px; margin-bottom: 5px; border-radius: 8px; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 10px; color: #D1D5DB;
        }
        .nav-item:hover, .nav-item.active { background: rgba(79, 70, 229, 0.2); color: white; }
        .nav-item i { width: 20px; text-align: center; }

        /* Main Content */
        .main-content { margin-left: 260px; flex: 1; padding: 30px; }
        
        /* View Switching Logic */
        .view-section { display: none; }
        .view-section.active-view { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Top Bar */
        .top-bar { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }
        .greeting h1 { font-size: 1.5rem; font-weight: 700; }
        
        .filter-group { display: flex; gap: 15px; align-items: center; }

        .time-filters {
            background: white; padding: 5px; border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex;
        }
        .filter-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 6px;
            cursor: pointer; font-weight: 600; color: var(--text-muted); transition: 0.2s;
        }
        .filter-btn.active { background: var(--primary); color: white; }

        .custom-date {
            display: flex; align-items: center; gap: 5px; background: white;
            padding: 5px 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .custom-date input { border: 1px solid #E5E7EB; padding: 6px; border-radius: 4px; color: var(--text-muted); outline: none; }
        .go-btn { background: var(--primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        
        .btn-group { display: flex; gap: 10px; }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .btn-success { background: var(--success); color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--bg-card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-label { font-size: 0.85rem; color: var(--text-muted); font-weight: 500; margin-bottom: 5px; }
        .card-value { font-size: 1.5rem; font-weight: 700; }
        .trend { font-size: 0.8rem; margin-top: 5px; display: inline-block; padding: 2px 6px; border-radius: 4px; }
        .trend.up { background: #D1FAE5; color: #065F46; }
        .trend.down { background: #FEE2E2; color: #991B1B; }

        /* Charts */
        .charts-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 380px; position: relative; display: flex; flex-direction: column; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .section-header { font-weight: 600; color: var(--text-main); }
        .chart-toggle { display: flex; background: #F3F4F6; border-radius: 20px; padding: 3px; }
        .toggle-btn { border: none; padding: 5px 12px; border-radius: 15px; font-size: 0.75rem; cursor: pointer; font-weight: 600; color: var(--text-muted); background: transparent; }
        .toggle-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .canvas-wrapper { flex: 1; position: relative; min-height: 0; }

        /* Tables */
        .table-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: var(--text-muted); font-size: 0.85rem; font-weight: 500; padding: 12px 0; border-bottom: 1px solid #E5E7EB; }
        td { padding: 15px 0; border-bottom: 1px solid #F3F4F6; font-size: 0.9rem; }
        .category-tag { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .delete-btn { color: var(--danger); background: #FEE2E2; border: none; cursor: pointer; padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; transition: 0.2s; }
        
        /* Category Colors */
        .cat-Income { background: #E0E7FF; color: #3730A3; }
        .cat-Savings { background: #DBEAFE; color: #1E40AF; }
        .cat-Fuel { background: #FEE2E2; color: #991B1B; }
        .cat-Maintenance { background: #FEF3C7; color: #92400E; }
        .cat-Insurance { background: #F3E8FF; color: #6B21A8; }
        .cat-Investments { background: #D1FAE5; color: #065F46; }
        .cat-Expenditure { background: #FEE2E2; color: #991B1B; }
        .cat-Miscellaneous { background: #F3F4F6; color: #374151; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-box { background: white; padding: 25px; border-radius: 12px; width: 400px; max-width: 90%; }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .close-modal { cursor: pointer; font-size: 1.2rem; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: var(--text-muted); }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #E5E7EB; border-radius: 6px; outline: none; }
        .submit-btn { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }

        /* Media Queries for Tablet/Mobile PWA support */
        @media (max-width: 768px) {
            .sidebar { width: 60px; padding: 20px 10px; }
            .sidebar h2, .nav-item span { display: none; } /* Compact Sidebar */
            .main-content { margin-left: 60px; padding: 15px; }
            .kpi-grid { grid-template-columns: 1fr 1fr; }
            .charts-container { grid-template-columns: 1fr; }
            .top-bar { flex-direction: column; align-items: flex-start; }
            .filter-group { width: 100%; overflow-x: auto; }
            table { min-width: 500px; } /* Horizontal scroll for table */
            .table-container { overflow-x: auto; }
        }
    </style>
</head>
<body>

    <div id="lock-screen">
        <div class="login-box" id="setup-box" style="display:none;">
            <h2>Secure App</h2>
            <p>Create a password</p>
            <input type="password" id="create-pwd" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="setupPassword()">Set Password</button>
        </div>
        <div class="login-box" id="login-box" style="display:none;">
            <h2>Welcome Back</h2>
            <input type="password" id="enter-pwd" class="login-input" placeholder="Password">
            <button class="login-btn" onclick="checkPassword()">Unlock</button>
            <div id="login-error" class="error-msg">Incorrect Password</div>
            <p style="margin-top:20px;font-size:0.8rem;color:#888;cursor:pointer" onclick="resetData()">Forgot Password?</p>
        </div>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <h2>FinanceTrack</h2>
            <div class="nav-item active" onclick="switchView('dashboard', this)"><i class="fas fa-home"></i> <span>Dashboard</span></div>
            <div class="nav-item" onclick="switchView('transactions', this)"><i class="fas fa-list"></i> <span>Transactions</span></div>
            <div class="nav-item"><i class="fas fa-chart-pie"></i> <span>Analytics</span></div>
            <div class="nav-item"><i class="fas fa-wallet"></i> <span>Budget</span></div>
            <div style="margin-top: auto;" class="nav-item" onclick="resetData()"><i class="fas fa-trash"></i> <span>Reset Data</span></div>
        </div>

        <div class="main-content">
            <div id="view-dashboard" class="view-section active-view">
                <div class="top-bar">
                    <div class="greeting"><h1>Overview</h1></div>
                    <div class="filter-group">
                        <div class="time-filters">
                            <button class="filter-btn" onclick="updateDashboard('daily', this)">Daily</button>
                            <button class="filter-btn" onclick="updateDashboard('weekly', this)">Weekly</button>
                            <button class="filter-btn active" onclick="updateDashboard('monthly', this)">Monthly</button>
                            <button class="filter-btn" onclick="updateDashboard('yearly', this)">Yearly</button>
                        </div>
                        <div class="custom-date">
                            <input type="date" id="startDate"><span style="font-size:0.8rem;color:#aaa">to</span><input type="date" id="endDate">
                            <button class="go-btn" onclick="applyCustomDate()">Go</button>
                        </div>
                    </div>
                </div>

                <div class="kpi-grid">
                    <div class="card"><div class="card-label">Total Income</div><div class="card-value" id="disp-income">₵0.00</div><div class="trend up"><i class="fas fa-arrow-up"></i> Salary</div></div>
                    <div class="card"><div class="card-label">Savings & Investments</div><div class="card-value" id="disp-savings">₵0.00</div><div class="trend up"><i class="fas fa-piggy-bank"></i> Assets</div></div>
                    <div class="card"><div class="card-label">Total Expenditure</div><div class="card-value" id="disp-expense" style="color:var(--danger)">₵0.00</div><div class="trend down">All Outflows</div></div>
                    <div class="card"><div class="card-label">Net Balance</div><div class="card-value" id="disp-balance">₵0.00</div><div class="trend"><i class="fas fa-wallet"></i> Remaining</div></div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <div class="chart-header">
                            <div class="section-header">Flow Analysis</div>
                            <div class="chart-toggle">
                                <button class="toggle-btn active" id="btn-summ" onclick="switchMainChart('summary')">Totals</button>
                                <button class="toggle-btn" id="btn-trend" onclick="switchMainChart('trend')">Trends</button>
                            </div>
                        </div>
                        <div class="canvas-wrapper"><canvas id="mainChart"></canvas></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header"><div class="section-header">Where did it go?</div></div>
                        <div class="canvas-wrapper"><canvas id="breakdownChart"></canvas></div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="section-header">Filtered Transactions</div>
                    <table>
                        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Type</th></tr></thead>
                        <tbody id="dashboard-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-transactions" class="view-section">
                <div class="top-bar">
                    <div class="greeting"><h1>Transactions</h1></div>
                    <div class="btn-group">
                        <button class="btn-success" onclick="exportToCSV()"><i class="fas fa-file-excel"></i> Export Excel</button>
                        <button class="btn-primary" onclick="openModal()"><i class="fas fa-plus"></i> Add New</button>
                    </div>
                </div>
                <div class="table-container">
                    <div class="section-header">All Records</div>
                    <table>
                        <thead><tr><th>Date</th><th>Category</th><th>Description</th><th>Amount</th><th>Action</th></tr></thead>
                        <tbody id="manage-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="txnModal">
        <div class="modal-box">
            <div class="modal-header"><h3>Add Transaction</h3><span class="close-modal" onclick="closeModal()">&times;</span></div>
            <form id="txnForm" onsubmit="saveTransaction(event)">
                <div class="form-group"><label>Date</label><input type="date" id="inp-date" required></div>
                <div class="form-group"><label>Category</label>
                    <select id="inp-category" required>
                        <option value="Income (Salaries)">Income (Salaries)</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Savings">Savings</option>
                        <option value="Investments">Investments</option>
                        <option value="Expenditure">Expenditure</option>
                        <option value="Fuel">Fuel</option>
                        <option value="Maintenance">Maintenance</option>
                        <option value="Miscellaneous">Miscellaneous</option>
                    </select>
                </div>
                <div class="form-group"><label>Description</label><input type="text" id="inp-desc" placeholder="e.g. Shell" required></div>
                <div class="form-group"><label>Amount (₵)</label><input type="number" id="inp-amount" step="0.01" required></div>
                <button type="submit" class="submit-btn">Save Entry</button>
            </form>
        </div>
    </div>

    <script>
        // PWA Installation Hook
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); }); }

        // --- AUTH & SECURITY ---
        const PWD_KEY = 'finance_tracker_pwd';
        function initAuth() {
            if(!localStorage.getItem(PWD_KEY)) document.getElementById('setup-box').style.display='block';
            else document.getElementById('login-box').style.display='block';
        }
        function setupPassword() {
            const pwd = document.getElementById('create-pwd').value;
            if(pwd.length<1) return alert("Enter password");
            localStorage.setItem(PWD_KEY, pwd);
            unlockApp();
        }
        function checkPassword() {
            if(document.getElementById('enter-pwd').value === localStorage.getItem(PWD_KEY)) unlockApp();
            else document.getElementById('login-error').style.display='block';
        }
        function unlockApp() {
            document.getElementById('lock-screen').style.display='none';
            document.getElementById('app-container').style.display='flex';
            updateDashboard('monthly');
        }

        // --- LOGIC ---
        const STORAGE_KEY = 'finance_tracker_v3';
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let currentFilteredData = [];
        let currentChartMode = 'summary';
        let mainChartInstance = null;
        let breakdownChartInstance = null;
        const categoriesList = ['Income (Salaries)', 'Insurance', 'Savings', 'Investments', 'Expenditure', 'Fuel', 'Maintenance', 'Miscellaneous'];

        function switchView(view, btn) {
            document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
            if(btn) btn.classList.add('active');
            document.querySelectorAll('.view-section').forEach(el=>el.classList.remove('active-view'));
            document.getElementById('view-'+view).classList.add('active-view');
            if(view==='dashboard') updateDashboard('monthly');
            else renderManageTable();
        }

        function saveToStorage() { localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions)); }
        function openModal() { document.getElementById('txnModal').style.display='flex'; document.getElementById('inp-date').valueAsDate=new Date(); }
        function closeModal() { document.getElementById('txnModal').style.display='none'; }
        
        function saveTransaction(e) {
            e.preventDefault();
            const cat = document.getElementById('inp-category').value;
            let type = (cat.includes('Income')) ? 'income' : (['Savings','Investments'].includes(cat) ? 'savings' : 'expense');
            transactions.push({
                id: Date.now(),
                date: document.getElementById('inp-date').value,
                category: cat,
                desc: document.getElementById('inp-desc').value,
                amount: parseFloat(document.getElementById('inp-amount').value),
                type: type
            });
            saveToStorage(); closeModal(); document.getElementById('txnForm').reset();
            if(document.getElementById('view-transactions').classList.contains('active-view')) renderManageTable();
            else updateDashboard(null,null);
        }

        function deleteTransaction(id) {
            if(confirm('Delete transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                saveToStorage(); renderManageTable();
            }
        }
        
        function resetData() {
            if(confirm('Wipe ALL data?')) { localStorage.clear(); location.reload(); }
        }

        function exportToCSV() {
            let csv = "Date,Category,Desc,Amount,Type\n" + transactions.map(t=>`${t.date},${t.category},${t.desc},${t.amount},${t.type}`).join("\n");
            let link = document.createElement("a");
            link.href = "data:text/csv;charset=utf-8," + encodeURI(csv);
            link.download = "data.csv";
            link.click();
        }

        function updateDashboard(timeframe, btn) {
            if(btn) { document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); }
            const now = new Date();
            const mode = timeframe || 'monthly';
            currentFilteredData = transactions.filter(t => {
                if(mode==='monthly') return t.date.startsWith(now.toISOString().slice(0,7));
                if(mode==='yearly') return t.date.startsWith(now.getFullYear().toString());
                return true;
            }).sort((a,b)=>new Date(b.date)-new Date(a.date));
            refreshUI();
        }

        function applyCustomDate() {
            const s=new Date(document.getElementById('startDate').value), e=new Date(document.getElementById('endDate').value);
            currentFilteredData = transactions.filter(t=>{ const d=new Date(t.date); return d>=s && d<=e; }).sort((a,b)=>new Date(b.date)-new Date(a.date));
            refreshUI();
        }

        function refreshUI() {
            let inc=0, exp=0, sav=0, bd={};
            currentFilteredData.forEach(t=>{
                if(t.type==='income') inc+=t.amount;
                else if(t.type==='savings') sav+=t.amount;
                else { exp+=t.amount; bd[t.category]=(bd[t.category]||0)+t.amount; }
            });

            document.getElementById('disp-income').innerText="₵"+inc.toLocaleString();
            document.getElementById('disp-expense').innerText="₵"+exp.toLocaleString();
            document.getElementById('disp-savings').innerText="₵"+sav.toLocaleString();
            document.getElementById('disp-balance').innerText="₵"+(inc-exp-sav).toLocaleString();

            const tbody = document.getElementById('dashboard-table-body');
            tbody.innerHTML = '';
            currentFilteredData.slice(0,10).forEach(t => {
                let color = t.type==='income'?'green':(t.type==='expense'?'red':'blue');
                tbody.innerHTML += `<tr><td>${t.date}</td><td><span class="category-tag cat-${t.category.split(' ')[0]}">${t.category}</span></td><td>${t.desc}</td><td style="font-weight:bold;color:${color}">₵${t.amount.toLocaleString()}</td><td>${t.type}</td></tr>`;
            });
            updateCharts(bd, inc, exp, sav);
        }

        function renderManageTable() {
            const tbody = document.getElementById('manage-table-body');
            tbody.innerHTML = '';
            transactions.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(t => {
                let color = t.type==='income'?'green':(t.type==='expense'?'red':'blue');
                tbody.innerHTML += `<tr><td>${t.date}</td><td><span class="category-tag cat-${t.category.split(' ')[0]}">${t.category}</span></td><td>${t.desc}</td><td style="font-weight:bold;color:${color}">₵${t.amount.toLocaleString()}</td><td><button class="delete-btn" onclick="deleteTransaction(${t.id})"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        }

        function switchMainChart(mode) {
            currentChartMode = mode;
            document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
            document.getElementById(mode==='summary'?'btn-summ':'btn-trend').classList.add('active');
            refreshUI();
        }

        function updateCharts(bd, inc, exp, sav) {
            const ctxMain = document.getElementById('mainChart').getContext('2d');
            const ctxBreak = document.getElementById('breakdownChart').getContext('2d');
            if(mainChartInstance) mainChartInstance.destroy();
            if(breakdownChartInstance) breakdownChartInstance.destroy();

            if(currentChartMode==='summary') {
                mainChartInstance = new Chart(ctxMain, {
                    type: 'bar',
                    data: { labels: ['Total'], datasets: [{label:'Inc',data:[inc],backgroundColor:'#10B981'},{label:'Exp',data:[exp],backgroundColor:'#EF4444'},{label:'Sav',data:[sav],backgroundColor:'#4F46E5'}] },
                    options: { responsive:true, maintainAspectRatio:false }
                });
            } else {
                const map={};
                currentFilteredData.forEach(t=>{
                    if(!map[t.date]) map[t.date]={i:0,e:0};
                    if(t.type==='income') map[t.date].i+=t.amount;
                    else if(t.type==='expense') map[t.date].e+=t.amount;
                });
                const dates=Object.keys(map).sort();
                mainChartInstance = new Chart(ctxMain, {
                    type: 'line',
                    data: { labels:dates, datasets:[{label:'Inc',data:dates.map(d=>map[d].i),borderColor:'#10B981'},{label:'Exp',data:dates.map(d=>map[d].e),borderColor:'#EF4444'}] },
                    options: { responsive:true, maintainAspectRatio:false }
                });
            }

            breakdownChartInstance = new Chart(ctxBreak, {
                type: 'doughnut',
                data: { labels: Object.keys(bd), datasets: [{data: Object.values(bd), backgroundColor: ['#EF4444','#F59E0B','#FCD34D','#10B981','#3B82F6']}] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
            });
        }

        window.onload = initAuth;
    </script>
</body>
</html>
 